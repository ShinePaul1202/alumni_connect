{% extends "core/base.html" %}
{% load static %}

{% block title %}Messages | AluLink{% endblock %}

{% block content %}
<head>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- All page styles are included here for completeness -->
    <style>
        :root {
            --primary-color: #3b82f6; --sidebar-width: 260px; --text-dark: #0f172a;
            --text-muted: #64748b; --border-color: #e2e8f0;
        }
        html, body { font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        .dashboard-container { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: linear-gradient(-45deg, #1d2b64, #485563, #2b5876, #4e4376); background-size: 400% 400%; animation: gradientAnimation 15s ease infinite; padding: 1.5rem; display: flex; flex-direction: column; color: white; flex-shrink: 0; height: 100vh; position: sticky; top: 0; transition: margin-left 0.3s ease-in-out; position: relative; overflow: hidden; }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .floating-particle { position: absolute; width: 4px; height: 4px; background: rgba(59, 130, 246, 0.6); border-radius: 50%; pointer-events: none; animation: floatUp 6s ease-out infinite; }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(100px) scale(0); } 10% { opacity: 1; transform: translateY(80px) scale(1); } 50% { opacity: 0.8; transform: translateY(-20px) scale(1.2); } 100% { opacity: 0; transform: translateY(-120px) scale(0.5); } }
        .brand-logo { display: flex; align-items: center; gap: 0.75rem; color: #fff; text-decoration: none; font-size: 1.75rem; font-weight: 700; margin-bottom: 2.5rem; position: relative; z-index: 10; }
        .brand-logo svg { animation: brandGlow 3s ease-in-out infinite; }
        @keyframes brandGlow { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.3)); } 50% { transform: scale(1.01); filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.5)); } }
        .sidebar-nav { position: relative; z-index: 10; }
        .sidebar-nav .nav-item { display: flex; align-items: center; gap: 1rem; padding: 0.9rem 1rem; margin-bottom: 0.75rem; border-radius: 1rem; color: rgba(255, 255, 255, 0.9); text-decoration: none; transition: all 0.3s ease; position: relative; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .sidebar-nav .nav-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 1rem; opacity: 0; transition: opacity 0.3s ease; }
        .sidebar-nav .nav-item:not(.active):hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px) translateX(5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border-color: rgba(255, 255, 255, 0.2); }
        .sidebar-nav .nav-item:not(.active):hover::before { opacity: 1; }
        .sidebar-nav .nav-item.active { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #fff; font-weight: 500; box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4); transform: translateY(-3px); }
        .sidebar-nav .nav-item.active::before { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(99, 102, 241, 0.1) 100%); opacity: 1; }
        .sidebar-nav .nav-item i { width: 20px; text-align: center; }
        .sidebar-nav .nav-item.disabled { color: rgba(255, 255, 255, 0.4); pointer-events: none; }
        .main-content { flex-grow: 1; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 2.5rem; width: calc(100% - var(--sidebar-width)); position: relative; height: 100vh; display: flex; flex-direction: column; min-width: 0; }
        .main-content > * { position: relative; z-index: 2; }
        .main-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 1.5rem 2rem; border-radius: 2rem; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
        .header-title .main-title { font-weight: 700; margin: 0; font-size: 1.75rem; color: var(--text-dark); }
        .header-title .main-subtitle { color: var(--text-muted); margin: 0; font-size: 0.9rem; }
        .profile-dropdown { position: relative; }
        .profile-dropdown-btn img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; cursor: pointer; transition: all 0.3s ease; border: 2px solid rgba(59, 130, 246, 0.3); }
        .profile-dropdown-btn:hover img { transform: scale(1.1); box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
        .profile-dropdown-menu { position: absolute; top: 100%; right: 0; min-width: 200px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); padding: 0.5rem 0; z-index: 9999; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.3s ease; }
        .profile-dropdown:hover .profile-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .profile-dropdown-menu a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.25rem; color: var(--text-dark); text-decoration: none; font-size: 0.95rem; transition: background-color 0.2s ease; }
        .profile-dropdown-menu a:hover { background: rgba(59, 130, 246, 0.1); }
        .chat-app-container { flex-grow: 1; display: flex; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 2rem; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08); overflow: hidden; min-height: 0; }
        .chat-list-wrapper { width: 340px; flex-shrink: 0; border-right: 1px solid rgba(229, 231, 235, 0.5); display: flex; flex-direction: column; }
        .chat-list-header { padding: 1.5rem; border-bottom: 1px solid rgba(229, 231, 235, 0.3); background: rgba(248, 250, 252, 0.5); }
        .chat-list-search { background: rgba(241, 245, 249, 0.8); border: 1px solid rgba(229, 231, 235, 0.5); border-radius: 1rem; padding: 0.75rem 1.2rem; font-weight: 500; transition: all 0.3s ease; }
        .chat-list-search:focus { background: white; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-select { border-radius: 0.75rem; border: 1px solid rgba(229, 231, 235, 0.5); padding: 0.5rem 0.75rem; font-size: 0.875rem; background: rgba(248, 250, 252, 0.8); transition: all 0.3s ease; }
        .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-link-wrapper { position: relative; border-bottom: 1px solid rgba(229, 231, 235, 0.3); }
        .chat-link-wrapper:last-child { border-bottom: none; }
        .chat-link { display: block; padding: 1rem 1.5rem; text-decoration: none; color: inherit; transition: all 0.3s ease; position: relative; }
        .chat-link:hover { background: rgba(59, 130, 246, 0.05); transform: translateX(5px); }
        .chat-link.active { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%); border-left: 4px solid var(--primary-color); }
        .chat-link .avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.2); transition: all 0.3s ease; }
        .chat-link:hover .avatar { transform: scale(1.05); border-color: rgba(59, 130, 246, 0.4); }
        .last-message { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .chat-time { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
        .delete-chat-btn { position: absolute; top: 12px; right: 12px; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; opacity: 0; transition: all 0.3s ease; z-index: 100; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #dc2626; }
        .delete-chat-btn:hover { background: #dc2626; color: white; transform: scale(1.1); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        .chat-link-wrapper:hover .delete-chat-btn { opacity: 1; }
        .chat-window-wrapper { flex-grow: 1; min-width: 0; display: flex; align-items: center; justify-content: center; }
        @media (max-width: 991.98px) { .sidebar { position: fixed; left: 0; top: 0; z-index: 1050; transform: translateX(-100%); transition: transform 0.3s ease-in-out; } body.sidebar-visible .sidebar { transform: translateX(0); } .main-content { width: 100%; padding: 1rem; } .header-title { display: none; } .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 1040; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; } body.sidebar-visible .overlay { opacity: 1; pointer-events: auto; } .chat-window-wrapper { display: none; } .chat-list-wrapper { width: 100%; border-right: none; } body.mobile-chat-visible .chat-list-wrapper { display: none; } body.mobile-chat-visible .chat-window-wrapper { display: flex; width: 100%; } body.mobile-chat-visible .main-header { display: none; } body.mobile-chat-visible .main-content { padding: 0; } body.mobile-chat-visible .chat-app-container { height: 100%; border-radius: 0; } }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="overlay" id="overlay"></div>
        <aside class="sidebar" id="sidebar">
            <a href="{% url 'core:home' %}" class="brand-logo"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="outer-circle-nav" style="transform-origin: center;"><path d="M12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22C17.523 22 22 17.523 22 12C22 9.253 20.941 6.786 19.23 5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></g><g id="inner-circle-nav" style="transform-origin: center;"><path d="M15.195 8.368C14.337 7.51 13.235 7 12 7C9.239 7 7 9.239 7 12C7 13.235 7.51 14.337 8.368 15.195" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></g><g id="needle-nav"><path d="M12.5 12L19 5.5" stroke="#0D6EFD" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g></svg><span>AluLink</span></a>
            <nav class="sidebar-nav mt-3">
                {% if profile.user_type == 'student' %}<a href="{% url 'core:student_dashboard' %}" class="nav-item"><i class="fa-solid fa-table-columns fa-fw"></i><span>Dashboard</span></a>{% else %}<a href="{% url 'core:alumni_dashboard' %}" class="nav-item"><i class="fa-solid fa-table-columns fa-fw"></i><span>Dashboard</span></a>{% endif %}
                {% if profile.is_verified and not profile.fraud_warning %}
                    <a href="{% url 'core:find_alumni' %}" class="nav-item"><i class="fa-solid fa-users fa-fw"></i><span>Find Alumni</span></a>
                    <a href="{% url 'messaging:inbox' %}" class="nav-item active"><i class="fa-solid fa-envelope fa-fw"></i><span>Messages</span>{% if unread_message_count > 0 %}<span class="badge bg-danger ms-auto">{{ unread_message_count }}</span>{% endif %}</a>
                    <a href="{% url 'core:connection_requests' %}" class="nav-item"><i class="fa-solid fa-user-plus fa-fw"></i><span>Requests</span>{% if pending_request_count > 0 %}<span class="badge bg-danger ms-auto">{{ pending_request_count }}</span>{% endif %}</a>
                    <a href="{% url 'core:notification_list' %}" class="nav-item"><i class="fa-solid fa-bell fa-fw"></i><span>Notifications</span>{% if unread_notification_count > 0 %}<span class="badge bg-danger ms-auto">{{ unread_notification_count }}</span>{% endif %}</a>
                {% else %}
                    <a href="#" class="nav-item disabled"><i class="fa-solid fa-users fa-fw"></i><span>Find Alumni</span></a><a href="#" class="nav-item disabled"><i class="fa-solid fa-envelope fa-fw"></i><span>Messages</span></a><a href="#" class="nav-item disabled"><i class="fa-solid fa-user-plus fa-fw"></i><span>Requests</span></a><a href="#" class="nav-item disabled"><i class="fa-solid fa-bell fa-fw"></i><span>Notifications</span></a>
                {% endif %}
                <a href="{% url 'core:account_settings' %}" class="nav-item"><i class="fa-solid fa-gear fa-fw"></i><span>Settings</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="d-flex align-items-center"><button class="sidebar-toggle me-3 d-lg-none" id="sidebar-toggle-btn" type="button"><i class="fa-solid fa-bars"></i></button><div class="header-title"><h1 class="main-title">Messages</h1><p class="main-subtitle d-none d-lg-block">View and manage your conversations.</p></div></div>
                <div class="profile-dropdown"><div class="profile-dropdown-btn"><img src="{{ profile.avatar.url }}" alt="Profile"></div><div class="profile-dropdown-menu"><a href="{% url 'core:profile' %}"><i class="fa-solid fa-user fa-fw"></i> My Profile</a><a href="{% url 'core:account_settings' %}"><i class="fa-solid fa-gear fa-fw"></i> Settings</a><hr class="my-1"><a href="{% url 'core:logout' %}"><i class="fa-solid fa-right-from-bracket fa-fw"></i> Logout</a></div></div>
            </header>

            <div class="chat-app-container">
                <div class="chat-list-wrapper" id="chat-list-col">
                    <div class="chat-list-header">
                        <input type="text" id="chat-search-input" class="form-control chat-list-search mb-3" placeholder="Search by name...">
                        <div class="d-flex gap-2">
                            <select id="chat-usertype-filter" class="form-select form-select-sm">
                                <option value="all" {% if not active_filter %}selected{% endif %}>All User Types</option>
                                <option value="student" {% if active_filter == 'students' %}selected{% endif %}>Students</option>
                                <option value="alumni" {% if active_filter == 'alumni' %}selected{% endif %}>Alumni</option>
                            </select>
                            <select id="chat-department-filter" class="form-select form-select-sm">
                                <option value="all" selected>All Departments</option>
                            </select>
                        </div>
                    </div>
                    <div class="list-group list-group-flush chat-list" id="chat-list-container">
                        {% for item in conversations %}
                            {% with convo=item.conversation other=item.other last=item.last last_message_text=item.last_message_text %}
                                <div class="chat-link-wrapper" id="convo-wrapper-{{ convo.id }}">
                                    <a href="{% url 'messaging:conversation_view' pk=convo.pk %}"
                                       class="list-group-item list-group-item-action p-3 chat-link"
                                       data-name="{% if other %}{{ other.get_full_name|default:other.username|lower }}{% else %}deleted user{% endif %}"
                                       data-usertype="{% if other %}{{ other.profile.user_type }}{% else %}none{% endif %}"
                                       data-department="{% if other %}{{ other.profile.department }}{% else %}none{% endif %}">
                                        <div class="d-flex align-items-center gap-3">
                                            {% if other %}
                                                <img src="{{ other.profile.avatar.url|default:'/static/core/img/avatar-placeholder.png' }}" alt="Avatar" class="avatar">
                                            {% else %}
                                                <div class="avatar bg-secondary d-flex align-items-center justify-content-center">
                                                    <i class="fa-solid fa-user-slash text-white"></i>
                                                </div>
                                            {% endif %}
                                            <div class="flex-grow-1 overflow-hidden">
                                                <div class="d-flex justify-content-between">
                                                    <h6 class="mb-0 fw-semibold">{% if other %}{{ other.get_full_name|default:other.username }}{% else %}Deleted User{% endif %}</h6>
                                                    {% if last %}<small class="chat-time">{{ last.created_at|time:"H:i" }}</small>{% endif %}
                                                </div>
                                                <p class="last-message mb-0 {% if not other %}fst-italic{% endif %}">
                                                    {{ last_message_text|truncatechars:25 }}
                                                </p>
                                            </div>
                                        </div>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger delete-chat-btn"
                                            data-leave-url="{% url 'messaging:leave_conversation_ajax' pk=convo.pk %}"
                                            aria-label="Delete Chat">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                            {% endwith %}
                        {% empty %}
                            <div class="p-4 text-center text-muted">No conversations yet.</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="chat-window-wrapper" id="chat-window-container">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="fa-solid fa-comments mb-3" style="font-size: 4rem; color: rgba(59, 130, 246, 0.3);"></i>
                            <h5 class="fw-bold">Your conversations will appear here</h5>
                            <p class="text-muted">Select a chat from the list to get started.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold" id="deleteModalLabel">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">Are you sure you want to remove this chat from your inbox? This action cannot be undone.</div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete Chat</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. SETUP & STATE MANAGEMENT ---
        const chatWindowContainer = document.getElementById('chat-window-container');
        const chatListContainer = document.getElementById('chat-list-container');
        const body = document.body;
        const csrftoken = getCookie("csrftoken");
        const currentUserId = parseInt("{{ request.user.id }}", 10);

        let chatSocket = null;
        let currentConversationId = null;
        let pressTimer = null;
        let selectionMode = false;
        let selectedMessages = new Set();
        let unreadMessagesQueue = new Set();

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

        // --- 2. WEBSOCKET LOGIC ---
        function connectToWebSocket(conversationId) {
            if (chatSocket && chatSocket.readyState !== WebSocket.CLOSED) chatSocket.close();
            currentConversationId = conversationId;
            unreadMessagesQueue.clear();
            const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${wsProtocol}://${window.location.host}/ws/chat/${conversationId}/`;
            chatSocket = new WebSocket(wsUrl);
            chatSocket.onopen = () => console.log(`WebSocket connected for conversation ${conversationId}.`);
            chatSocket.onmessage = handleSocketMessage;
            chatSocket.onclose = () => console.warn(`WebSocket disconnected from conversation ${conversationId}.`);
            chatSocket.onerror = (err) => console.error('WebSocket Error:', err);
        }

        function handleSocketMessage(e) {
            const data = JSON.parse(e.data);
            console.log("WebSocket received:", data);
            switch (data.type) {
                case 'new_message': handleNewMessage(data.message); break;
                case 'user_status': updateUserStatus(data.user_id, data.is_online); break;
                case 'message_delivered': updateMessageTicks(data.message_ids, 'delivered', data.delivered_to_id); break;
                case 'messages_read': updateMessageTicks(data.message_ids, 'read', data.reader_id); break;
                case 'message_deleted': document.querySelector(`.msg-wrapper[data-msg-id="${data.message_id}"]`)?.remove(); break;
            }
        }

        // --- 3. UI RENDERING & DOM MANIPULATION ---
        function handleNewMessage(messageData) {
            if (messageData.conversation_id == currentConversationId) {
                appendMessage(messageData, messageData.sender_id === currentUserId);
                if (messageData.sender_id !== currentUserId) {
                    sendDeliveryConfirmation([messageData.id]);
                    if (document.hidden) {
                        unreadMessagesQueue.add(messageData.id);
                    } else {
                        sendReadReceipt([messageData.id]);
                    }
                }
            }
            updateChatList(messageData);
        }
        
        function appendMessage(m, isMe) {
            const chatEl = document.getElementById("chat");
            if (!chatEl) return;
            const messageDate = new Date(m.created_at);
            const localTime = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            let fileHtml = '';
            if (m.files && m.files.length > 0) {
                m.files.forEach(file => {
                    if (/\.(jpe?g|png|gif|webp)$/i.test(file.name)) {
                        fileHtml += `<img src="${file.url}" class="img-fluid rounded my-2" style="max-height: 200px; cursor: pointer;" onclick="window.open('${file.url}', '_blank');">`;
                    } else {
                        fileHtml += `<a href="${file.url}" target="_blank" class="d-flex align-items-center text-decoration-none text-inherit my-2 p-2 rounded" style="background-color: rgba(0,0,0,0.1);"><i class="fa-solid fa-file-arrow-down me-2"></i><span>${file.name}</span></a>`;
                    }
                });
            }
            const textHtml = m.text ? m.text.replace(/\n/g, "<br>") : '';
            const readReceiptHtml = isMe ? `<span class="read-receipt-status ms-1" data-msg-id="${m.id}"><i class="fa-solid fa-check"></i></span>` : '';
            const deleteBtnHtml = isMe ? `<button class="btn btn-sm text-danger delete-msg-btn p-0 me-2" data-delete-url="/messages/delete-message/${m.id}/"><i class="fa-solid fa-trash-can"></i></button>` : '';
            const wrapper = document.createElement("div");
            wrapper.className = `d-flex flex-column mb-3 msg-wrapper ${isMe ? "align-items-end" : "align-items-start"}`;
            wrapper.dataset.msgId = m.id;
            wrapper.innerHTML = `<div class="msg-bubble ${isMe ? 'msg-sent' : 'msg-received'}">${fileHtml}${textHtml}</div><div class="d-flex align-items-center mt-1">${deleteBtnHtml}<small class="msg-time">${localTime}</small>${readReceiptHtml}</div>`;
            chatEl.appendChild(wrapper);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function updateUserStatus(userId, isOnline) {
            if (userId === currentUserId) return;
            const statusEl = document.getElementById('user-status-text');
            if (statusEl) {
                statusEl.textContent = isOnline ? 'Online' : 'Offline';
                statusEl.classList.toggle('text-success', isOnline);
                statusEl.classList.toggle('text-muted', !isOnline);
            }
        }

        function updateMessageTicks(messageIds, status, actorId) {
            if (actorId === currentUserId) return; // Don't update based on your own actions
            messageIds.forEach(id => {
                const receiptEl = document.querySelector(`.read-receipt-status[data-msg-id="${id}"]`);
                if (!receiptEl) return;
                let newTickHtml = '';
                if (status === 'delivered' && !receiptEl.classList.contains('read')) {
                    newTickHtml = `<i class="fa-solid fa-check-double"></i>`;
                } else if (status === 'read') {
                    receiptEl.classList.add('read');
                    newTickHtml = `<i class="fa-solid fa-check-double" style="color: #3b82f6;"></i>`;
                }
                if (newTickHtml) receiptEl.innerHTML = newTickHtml;
            });
        }

        function updateChatList(messageData) {
            const convoId = messageData.conversation_id;
            const chatLinkWrapper = document.getElementById(`convo-wrapper-${convoId}`);
            if (!chatLinkWrapper) return;
            const lastMessageEl = chatLinkWrapper.querySelector('.last-message');
            const chatTimeEl = chatLinkWrapper.querySelector('.chat-time');
            if (lastMessageEl) {
                let prefix = messageData.sender_id === currentUserId ? "You: " : "";
                let text = messageData.files && messageData.files.length > 0 ? (messageData.text || 'Sent an attachment') : messageData.text;
                lastMessageEl.textContent = `${prefix}${text}`.substring(0, 25) + (text.length > 25 ? '...' : '');
            }
            if (chatTimeEl) chatTimeEl.textContent = new Date(messageData.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            chatListContainer.prepend(chatLinkWrapper);
        }
        
        function sendDeliveryConfirmation(messageIds) {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN && messageIds.length > 0) {
                chatSocket.send(JSON.stringify({ type: 'delivery_confirmation', message_ids: Array.from(messageIds) }));
            }
        }
        
        function sendReadReceipt(messageIds) {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN && messageIds.length > 0) {
                chatSocket.send(JSON.stringify({ type: 'read_receipt', message_ids: Array.from(messageIds) }));
            }
        }
        
        // --- 4. EVENT LISTENERS & HANDLERS ---
        
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden && currentConversationId && unreadMessagesQueue.size > 0) {
                sendReadReceipt(Array.from(unreadMessagesQueue));
                unreadMessagesQueue.clear();
            }
        });

        chatListContainer.addEventListener('click', function(event) {
            const link = event.target.closest('.chat-link');
            const deleteBtn = event.target.closest('.delete-chat-btn');
            if (deleteBtn) {
                event.preventDefault(); event.stopPropagation();
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                confirmBtn.dataset.leaveUrl = deleteBtn.dataset.leaveUrl;
                confirmBtn.dataset.targetId = deleteBtn.closest('.chat-link-wrapper').id;
                deleteModal.show();
            } else if (link) {
                event.preventDefault();
                exitSelectionMode();
                document.querySelector('.chat-link.active')?.classList.remove('active');
                link.classList.add('active');
                const conversationId = link.getAttribute('href').match(/\/conversation\/(\d+)\//)[1];
                const fetchUrl = `/messages/fetch-html/${conversationId}/`;
                chatWindowContainer.innerHTML = `<div class="d-flex align-items-center justify-content-center h-100"><div class="spinner-border text-primary"></div></div>`;
                fetch(fetchUrl)
                    .then(response => response.text())
                    .then(html => {
                        chatWindowContainer.innerHTML = html;
                        document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
                        connectToWebSocket(conversationId);
                        body.classList.add('mobile-chat-visible');
                    });
            }
        });

        chatWindowContainer.addEventListener('submit', async function(event) {
            if (event.target.id !== 'send-form') return;
            event.preventDefault();
            const formEl = event.target;
            const inputEl = formEl.querySelector('textarea[name="text"]');
            const fileInput = formEl.querySelector('input[type="file"]');
            const text = inputEl.value.trim();
            const files = fileInput.files;
            if (!text && files.length === 0) return;
            if (files.length > 0) {
                const formData = new FormData(formEl);
                const sendUrl = `/messages/send/${currentConversationId}/`;
                try {
                    const response = await fetch(sendUrl, {method: "POST", headers: { "X-CSRFToken": csrftoken, "Accept": "application/json" }, body: formData});
                    const data = await response.json();
                    if (!data.ok) alert("Error uploading file: " + data.error);
                } catch (error) { console.error("Failed to send file message:", error); }
            } else {
                if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.send(JSON.stringify({ type: 'chat_message', message: text }));
                }
            }
            formEl.reset();
            document.getElementById('file-preview-container')?.classList.add('d-none');
            inputEl.focus();
        });

        chatWindowContainer.addEventListener('click', async function(event) {
            if (event.target.closest('#back-to-chats-btn')) { body.classList.remove('mobile-chat-visible'); exitSelectionMode(); }
            if (event.target.closest('#cancel-selection-btn')) { exitSelectionMode(); }
            if (event.target.closest('#file-preview-clear')) {
                const fileInput = document.getElementById('file-upload-input');
                if(fileInput) fileInput.value = '';
                document.getElementById('file-preview-container').classList.add('d-none');
            }
            const msgWrapper = event.target.closest('.msg-wrapper.can-select');
            if (selectionMode && msgWrapper) { toggleMessageSelection(msgWrapper); return; }
            const deleteBtn = event.target.closest('.delete-msg-btn');
            if (deleteBtn && !selectionMode) {
                if (!confirm('Are you sure you want to delete this message?')) return;
                try {
                    const res = await fetch(deleteBtn.dataset.deleteUrl, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
                    const data = await res.json();
                    if (!data.ok) alert('Error: ' + data.error);
                } catch (err) { alert('An error occurred.'); }
            }
            const deleteSelectedBtn = event.target.closest('#delete-selected-btn');
            if (deleteSelectedBtn && selectedMessages.size > 0) {
                if (!confirm(`Are you sure you want to delete ${selectedMessages.size} messages?`)) return;
                try {
                    const res = await fetch("{% url 'messaging:delete_messages_bulk_ajax' %}", { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: Array.from(selectedMessages) }) });
                    const data = await res.json();
                    if (data.ok) {
                        selectedMessages.forEach(id => document.querySelector(`.msg-wrapper[data-msg-id="${id}"]`)?.remove());
                        exitSelectionMode();
                    } else { alert('Error: ' + data.error); }
                } catch (err) { alert('An error occurred.'); }
            }
        });

        chatWindowContainer.addEventListener('change', function(event) {
            const fileInput = event.target;
            if (fileInput.matches('#file-upload-input')) {
                const previewContainer = document.getElementById('file-preview-container');
                const previewName = document.getElementById('file-preview-name');
                if (fileInput.files.length > 0) {
                    previewName.textContent = fileInput.files.length === 1 ? fileInput.files[0].name : `${fileInput.files.length} files selected`;
                    previewContainer.classList.remove('d-none');
                } else { previewContainer.classList.add('d-none'); }
            }
        });
        
        chatWindowContainer.addEventListener('keydown', function(event) {
            if (event.target.matches('.chat-input') && event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                event.target.closest('form').querySelector('.send-btn').click();
            }
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            const { leaveUrl, targetId } = this.dataset;
            if (!leaveUrl || !targetId) return;
            try {
                const res = await fetch(leaveUrl, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
                const data = await res.json();
                if (data.ok) {
                    document.getElementById(targetId)?.remove();
                    if (`convo-wrapper-${currentConversationId}` === targetId) {
                         chatWindowContainer.innerHTML = `<div class="d-flex align-items-center justify-content-center h-100"><div class="text-center"><i class="fa-solid fa-comments mb-3" style="font-size: 4rem; color: rgba(59, 130, 246, 0.3);"></i><h5 class="fw-bold">Your conversations will appear here</h5><p class="text-muted">Select a chat from the list to get started.</p></div></div>`;
                    }
                } else { alert('Error: ' + data.error); }
            } catch (err) { alert('An error occurred.'); } 
            finally { deleteModal.hide(); }
        });
        
        chatWindowContainer.addEventListener('pointerdown', (e) => {
            const msgWrapper = e.target.closest('.msg-wrapper');
            if (msgWrapper && msgWrapper.querySelector('.delete-msg-btn') && !selectionMode) {
                pressTimer = window.setTimeout(() => enterSelectionMode(msgWrapper), 500);
            }
        });
        chatWindowContainer.addEventListener('pointerup', () => clearTimeout(pressTimer));
        chatWindowContainer.addEventListener('pointerleave', () => clearTimeout(pressTimer));

        // --- 5. MULTI-DELETE FUNCTIONS ---
        function enterSelectionMode(initialMessageWrapper){if(selectionMode)return;selectionMode=!0,document.querySelector(".chat-container-card")?.classList.add("selection-active");const e=document.getElementById("chat");e&&(e.classList.add("selection-mode"),e.querySelectorAll(".msg-wrapper").forEach(e=>{e.querySelector(".delete-msg-btn")&&e.classList.add("can-select")})),toggleMessageSelection(initialMessageWrapper)}function exitSelectionMode(){if(!selectionMode)return;selectionMode=!1,document.querySelector(".chat-container-card")?.classList.remove("selection-active");const e=document.getElementById("chat");e&&(e.classList.remove("selection-mode"),e.querySelectorAll(".msg-wrapper.selected").forEach(e=>e.classList.remove("selected")),e.querySelectorAll(".can-select").forEach(e=>e.classList.remove("can-select"))),selectedMessages.clear()}function toggleMessageSelection(e){const t=e.dataset.msgId;selectedMessages.has(t)?(selectedMessages.delete(t),e.classList.remove("selected")):(selectedMessages.add(t),e.classList.add("selected")),updateSelectionUI()}function updateSelectionUI(){const e=document.getElementById("selection-count"),t=document.getElementById("delete-selected-btn");e&&(e.textContent=`${selectedMessages.size} Selected`),t&&(t.disabled=0===selectedMessages.size)}
        
        // --- 6. UTILITY & INITIALIZATION ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break;
                    }
                }
            }
            return cookieValue;
        }

        const searchInput = document.getElementById('chat-search-input');
        const userTypeFilter = document.getElementById('chat-usertype-filter');
        const departmentFilter = document.getElementById('chat-department-filter');
        const originalConversations = Array.from(document.querySelectorAll('#chat-list-container .chat-link-wrapper'));
        function filterChats() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedUserType = userTypeFilter.value;
            const selectedDepartment = departmentFilter.value;
            originalConversations.forEach(wrapper => {
                const link = wrapper.querySelector('.chat-link');
                const nameMatch = link.dataset.name.includes(searchTerm);
                const userTypeMatch = (selectedUserType === 'all' || link.dataset.usertype === selectedUserType);
                const departmentMatch = (selectedDepartment === 'all' || link.dataset.department === selectedDepartment);
                wrapper.style.display = (nameMatch && userTypeMatch && departmentMatch) ? '' : 'none';
            });
        }
        searchInput.addEventListener('input', filterChats);
        userTypeFilter.addEventListener('change', filterChats);
        departmentFilter.addEventListener('change', filterChats);
        document.getElementById('sidebar-toggle-btn')?.addEventListener('click', () => body.classList.toggle('sidebar-visible'));
        document.getElementById('overlay')?.addEventListener('click', () => body.classList.remove('sidebar-visible'));
        const urlParams = new URLSearchParams(window.location.search);
        const openChatId = urlParams.get('open_chat');
        if (openChatId) {
            document.querySelector(`a.chat-link[href*='/conversation/${openChatId}/']`)?.click();
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });
    </script>
</body>
{% endblock %}
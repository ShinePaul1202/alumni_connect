{% extends "core/base.html" %}
{% load static %}

{% block title %}Chat with {{ other_user.get_full_name|default:other_user.username }}{% endblock %}

{% block content %}
<head>
    <!-- This page now uses the main site styles, but we add chat-specific ones -->
    <style>
        .main-content {
            padding: 0 !important;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-header {
            display: none; /* Hide the default header on this page */
        }
        .chat-container-card {
            height: 100%;
            border-radius: 0;
            box-shadow: none;
        }
        /* All other chat styles will come from the main inbox.html styles */
    </style>
</head>

<body>
    <!-- 
        This template now just acts as a container.
        It includes the _chat_window.html partial which has all the features.
        We must pass the context variables it needs.
    -->
    {% include 'messaging/_chat_window.html' with conversation=conversation messages=messages other_user=other_user %}
</body>

<!-- We also need the JavaScript logic here for the standalone page to work -->
<script>
    // This script block is a simplified version for the fallback page
    document.addEventListener('DOMContentLoaded', function() {
        const chatEl = document.getElementById("chat");
        const formEl = document.getElementById("send-form");
        const csrftoken = getCookie("csrftoken");
        let lastId = 0;
        
        // --- All the necessary JS functions ---
        function getCookie(name) { /* ... (full function here) ... */ }
        function appendMessage(m, isMe) { /* ... (full function here) ... */ }
        function startPolling(pollUrl) { /* ... (full function here) ... */ }
        
        // Initialize and start polling
        if (chatEl) {
            const items = chatEl.querySelectorAll("[data-id]");
            lastId = items.length ? parseInt(items[items.length - 1].getAttribute("data-id") || "0") : 0;
            chatEl.scrollTop = chatEl.scrollHeight;
            startPolling(chatEl.dataset.pollUrl);
        }

        // Event listener for sending messages
        if (formEl) {
            formEl.addEventListener('submit', async function(event) {
                event.preventDefault();
                // ... (full submit logic here)
            });
        }
        
        // Event listener for deleting messages
        chatEl.addEventListener('click', async function(event) {
            const deleteBtn = event.target.closest('.delete-msg-btn');
            if (deleteBtn) {
                // ... (full delete logic here)
            }
        });

        // (You would paste the full JS functions from inbox.html here for completeness)
    });
</script>
{% endblock %}
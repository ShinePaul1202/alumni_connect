{% extends "core/base.html" %}
{% load static %}

{% block title %}Chat{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.chat-area { height: 60vh; overflow-y: auto; background:#f8fafc; padding:1rem; border-radius:8px; }
.msg { max-width: 75%; padding:.6rem .9rem; border-radius:12px; margin-bottom:.5rem; word-wrap:break-word; }
.me { margin-left: auto; background:#0d6efd; color:white; }
.them { margin-right: auto; background:#e9ecef; color:#111827; }
</style>

<div class="container py-4">
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <img src="{{ other_user.profile.avatar.url|default:'/static/core/img/avatar-placeholder.png' }}" style="width:44px;height:44px;border-radius:50%;object-fit:cover;">
        <div>
          <strong>{{ other_user.get_full_name|default:other_user.username }}</strong><br>
          <small class="text-muted">{{ other_user.profile.department|default:"" }}</small>
        </div>
      </div>
      <div>
        <a href="{% url 'messaging:inbox' %}" class="btn btn-sm btn-outline-secondary">Back</a>
      </div>
    </div>

    <div class="card-body">
      <div id="chat" class="chat-area">
        {% for m in messages %}
          <div class="d-flex {% if m.sender_id == request.user.id %}justify-content-end{% endif %}">
            <div class="msg {% if m.sender_id == request.user.id %}me{% else %}them{% endif %}" data-id="{{ m.id }}">
              <div class="small text-muted mb-1">
                {% if m.sender_id != request.user.id %}{{ m.sender.username }} • {% endif %}
                {{ m.created_at|time:"H:i" }}
              </div>
              <div>{{ m.text|linebreaksbr }}</div>
            </div>
          </div>
        {% endfor %}
      </div>

      <form id="send-form" class="mt-3 d-flex gap-2">
        {% csrf_token %}
        <input id="msg-input" name="text" class="form-control" placeholder="Type a message..." autocomplete="off">
        <button class="btn btn-primary" type="submit">Send</button>
      </form>
    </div>
  </div>
</div>

<script>
// CSRF helper
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

const chatEl = document.getElementById("chat");
const formEl = document.getElementById("send-form");
const inputEl = document.getElementById("msg-input");
let lastId = 0;
(function initLastId(){
  const items = chatEl.querySelectorAll("[data-id]");
  if (items.length) {
    lastId = parseInt(items[items.length-1].getAttribute("data-id") || "0");
  }
})();

formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = inputEl.value.trim();
  if (!text) return;
  const sendUrl = "{% url 'messaging:send_message' pk=conversation.pk %}";
  try {
    const res = await fetch(sendUrl, {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken, "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ text })
    });
    const data = await res.json();
    if (data.ok) {
      appendMessage(data, data.sender_id === {{ request.user.id }});
      inputEl.value = "";
      chatEl.scrollTop = chatEl.scrollHeight;
    }
  } catch (err) {
    console.error(err);
  }
});

function appendMessage(m, isMe) {
  lastId = m.id;
  const wrap = document.createElement("div");
  wrap.className = "d-flex " + (isMe ? "justify-content-end" : "");
  const bubble = document.createElement("div");
  bubble.className = "msg " + (isMe ? "me" : "them");
  bubble.setAttribute("data-id", m.id);
  bubble.innerHTML = `<div class="small text-muted mb-1">${isMe ? "" : (m.sender_username + " • ")}${m.created}</div><div></div>`;
  bubble.lastElementChild.textContent = m.text;
  wrap.appendChild(bubble);
  chatEl.appendChild(wrap);
}

// polling
async function poll() {
  const url = "{% url 'messaging:fetch_messages' pk=conversation.pk %}" + "?after=" + (lastId || 0);
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.ok && data.messages.length) {
      data.messages.forEach(m => appendMessage(m, m.sender_id === {{ request.user.id }}));
      chatEl.scrollTop = chatEl.scrollHeight;
    }
  } catch (e) {
    // ignore network hiccups
  }
}
setInterval(poll, 2000);
chatEl.scrollTop = chatEl.scrollHeight;
</script>
{% endblock %}
